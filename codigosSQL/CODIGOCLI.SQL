-- CODIGO DE LA TABLA STAGING
CREATE TABLE STG_CLIENTE(
   NUM_NIT NUMBER(15),
   STR_RAZON_SOCIAL VARCHAR2(100),
   STR_SUCURSAL VARCHAR2(4),
   STR_RAZON_SOCIAL_SUCURSAL VARCHAR2(100),
   STR_TELEFONO VARCHAR2(15),
   STR_DIRECCION VARCHAR2(150),
   STR_CONTACTO_PRINCIPAL VARCHAR2(100),
   DT_FECHA_INGRESO DATE,
   STR_ANTIGUEDAD VARCHAR2(20),
   STR_CALIFICACION VARCHAR2(5),
   STR_CONDICION_DE_PAGO VARCHAR2(5),
   STR_DESC_CONDICION_DE_PAGO VARCHAR2(20),
   STR_CARTERA	VARCHAR2(35),
   STR_FACTURACION VARCHAR2(25),
   STR_SECTOR_ECONOMICO VARCHAR2(6),
   STR_SERVICIO_QUE_PREDOMINA	VARCHAR2(6),
   STR_TIPO_EMPRESA VARCHAR2(20)
);


-- CODIGO CREACION DE LA DIMENSIONN CLIENTE
CREATE TABLE DIM_CLIENTE (
   SK_NUM_DIM_CLIENTE NUMBER(7),
   NUM_NIT NUMBER(15) NOT NULL,    
   STR_RAZON_SOCIAL VARCHAR2(100), 
   STR_SUCURSAL VARCHAR2(4) NOT NULL, 
   STR_RAZON_SOCIAL_SUCURSAL VARCHAR2(100),
   STR_TELEFONO VARCHAR2(15), 
   STR_DIRECCION VARCHAR2(150), 
   STR_CONTACTO_PRINCIPAL VARCHAR2(100), 
   DT_FECHA_INGRESO DATE, 
   STR_ANTIGUEDAD VARCHAR2(20), 
   STR_CALIFICACION VARCHAR2(5), 
   STR_CONDICION_DE_PAGO VARCHAR2(5), 
   STR_DESC_CONDICION_DE_PAGO VARCHAR2(20), 
   STR_CARTERA VARCHAR2(35), 
   STR_FACTURACION VARCHAR2(25), 
   STR_SECTOR_ECONOMICO VARCHAR2(6), 
   STR_SERVICIO_QUE_PREDOMINA VARCHAR2(6), 
   STR_TIPO_EMPRESA VARCHAR2(20), 
   DT_FECHA_INSERCION DATE,
   DT_FECHA_ACTUALIZACION DATE,
   DT_FECHA_FIN DATE
);


--comentarios de las columnas

COMMENT ON COLUMN DIM_CLIENTE.SK_NUM_DIM_CLIENTE IS 'SECUENCIA GENERADA AUTOMATICAMENTE';
COMMENT ON COLUMN DIM_CLIENTE.NUM_NIT IS 'IDENTIFICADOR UNICO DEL CLIENTE';
COMMENT ON COLUMN DIM_CLIENTE.STR_RAZON_SOCIAL IS 'RAZON SOCIAL DEL CLIENTE';
COMMENT ON COLUMN DIM_CLIENTE.STR_SUCURSAL IS 'IDENTIFICADOR UNICO DE LA SUCURSAL';
COMMENT ON COLUMN DIM_CLIENTE.STR_RAZON_SOCIAL_SUCURSAL IS 'NOMBRE DE LA SUCURSAL DONDE SE PRESTA EL SERVICIO';
COMMENT ON COLUMN DIM_CLIENTE.STR_TELEFONO IS 'TELEFONO DE LA SUCURSAL DONDE SE PRESTA EL SERVICIO';
COMMENT ON COLUMN DIM_CLIENTE.STR_DIRECCION IS 'DIRECCION DE LA SUCURSAL DONDE SE PRESTA EL SERVICIO';
COMMENT ON COLUMN DIM_CLIENTE.STR_CONTACTO_PRINCIPAL IS 'CONTACTO PRINCIPAL DE LA SUCURSAL DONDE SE PRESTA EL SERVICIO';
COMMENT ON COLUMN DIM_CLIENTE.DT_FECHA_INGRESO IS 'FECHA DE INICIO DEL CONTRATO';
COMMENT ON COLUMN DIM_CLIENTE.STR_ANTIGUEDAD IS 'ATIGUEDAD DEL CONTRATO';
COMMENT ON COLUMN DIM_CLIENTE.STR_CALIFICACION IS 'CALIFICACION DEL CLIENTE';
COMMENT ON COLUMN DIM_CLIENTE.STR_CONDICION_DE_PAGO IS 'ID DE LA CONDICION DE PAGO';
COMMENT ON COLUMN DIM_CLIENTE.STR_DESC_CONDICION_DE_PAGO IS 'DESCRIPCION DE LA CONDICION DE PAGO';
COMMENT ON COLUMN DIM_CLIENTE.STR_CARTERA IS 'DESCRIPCION DE LA CARTERA';
COMMENT ON COLUMN DIM_CLIENTE.STR_FACTURACION IS 'DESCRIPCION DEL TIPO DE FACTURACION';
COMMENT ON COLUMN DIM_CLIENTE.STR_SECTOR_ECONOMICO IS 'ID DEL SECTOR ECONOMICO EN EL CUAL OPERA EL CLIENTE';
COMMENT ON COLUMN DIM_CLIENTE.STR_SERVICIO_QUE_PREDOMINA IS 'SERVICIO QUE MAYORITARIAMENTE CONTRATA EL CLIENTE';
COMMENT ON COLUMN DIM_CLIENTE.STR_TIPO_EMPRESA IS 'TIPO DE SECTOR DONDE OPERA EL CLIENTE, PUBLICO O PRIVADO';
COMMENT ON COLUMN DIM_CLIENTE.DT_FECHA_INSERCION IS 'FECHA DE INSERCION DE LOS REGISTROS';
COMMENT ON COLUMN DIM_CLIENTE.DT_FECHA_ACTUALIZACION IS 'FECHA DE ACTUALIZACION DE LOS REGISTROS';
COMMENT ON COLUMN DIM_CLIENTE.DT_FECHA_FIN IS 'FECHA DE ELIMINACION DEL REGISTRO';



--INDICE UNICO COMPUESTO DE LA DIMENSION CLIENTE
CREATE UNIQUE INDEX IDX_NIT_STR_SUCURSAL
ON DIM_CLIENTE (NUM_NIT, STR_SUCURSAL);


-- codigo de la secuencia
CREATE SEQUENCE SEQ_SK_DIM_CLIENTE
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;


--TRIGGER FECHA ACTUALIZACION DIMENSION CLIENTE
CREATE OR REPLACE TRIGGER TRG_ACTUALIZAR_FECHA_DIM_CLIENTE
BEFORE UPDATE ON DIM_CLIENTE
FOR EACH ROW
WHEN (OLD.STR_RAZON_SOCIAL != NEW.STR_RAZON_SOCIAL OR
      OLD.STR_RAZON_SOCIAL_SUCURSAL != NEW.STR_RAZON_SOCIAL_SUCURSAL OR
      OLD.STR_TELEFONO != NEW.STR_TELEFONO OR
      OLD.STR_DIRECCION != NEW.STR_DIRECCION OR
      OLD.STR_CONTACTO_PRINCIPAL != NEW.STR_CONTACTO_PRINCIPAL OR
      OLD.STR_ANTIGUEDAD != NEW.STR_ANTIGUEDAD OR
      OLD.STR_CALIFICACION != NEW.STR_CALIFICACION OR
      OLD.STR_CONDICION_DE_PAGO != NEW.STR_CONDICION_DE_PAGO OR
      OLD.STR_DESC_CONDICION_DE_PAGO != NEW.STR_DESC_CONDICION_DE_PAGO OR
      OLD.STR_CARTERA != NEW.STR_CARTERA OR
      OLD.STR_FACTURACION != NEW.STR_FACTURACION OR
      OLD.STR_SECTOR_ECONOMICO != NEW.STR_SECTOR_ECONOMICO OR
      OLD.STR_SERVICIO_QUE_PREDOMINA != NEW.STR_SERVICIO_QUE_PREDOMINA OR
      OLD.STR_TIPO_EMPRESA != NEW.STR_TIPO_EMPRESA
)
BEGIN    
   :NEW.DT_FECHA_ACTUALIZACION := SYSDATE;
END;
/


________________________________________________________________________________
--DIMENSION SECTOR ECONOMICO

--STAGING SECTOR ECONOMICO
CREATE TABLE STG_SECTOR_ECO(
   NUM_CODIGO_SECTOR NUMBER(6),
   STR_SECTOR VARCHAR2(35)
);

--DIMENSION SECTOR ECONOMICO
CREATE TABLE DIM_SECTOR_ECO(
   SK_NUM_DIM_SECTOR NUMBER(7),
   NUM_CODIGO_SECTOR NUMBER(6),
   STR_SECTOR VARCHAR2(35),
   DT_FECHA_INSERCION DATE,
   DT_FECHA_ACTUALIZACION DATE,
   DT_FECHA_FIN DATE
   CONSTRAINT UQ_CODIGO_SECTOR UNIQUE (NUM_CODIGO_SECTOR)
);


--SECUENCIA DE LA DIMENSION SECTOR ECONOMICO
CREATE SEQUENCE SEQ_SK_DIM_SECTOR_ECO
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;


--TRIGGER FECHA ACTIUALIZACION DIMENSION SECTOR ECONOMICO
CREATE OR REPLACE TRIGGER TRG_FECHA_ACTUALIZACION_DIM_SECTOR_ECO
BEFORE UPDATE ON DIM_SECTOR_ECO
FOR EACH ROW
WHEN(OLD.STR_SECTOR != NEW.STR_SECTOR)
BEGIN
   :NEW.DT_FECHA_ACTUALIZACION := SYSDATE;
END;
/

